<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperory URL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.0.5/build/pure-min.min.css">
    <style>
        #app {
            max-width: 768px;
            margin: 0 auto;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif
        }

        .button-success {
            background: rgb(28, 184, 65);
        }

        .button-error {
            background: rgb(202, 60, 60);
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <h1>Temperory URL</h1>
            <noscript>
                <h2>This website requires Javascript. Use API instead.</h2>
            </noscript>
        </div>
        <form class="pure-form pure-form-stacked">
            <fieldset>
                <input id="url" class="pure-input-1" type="text" placeholder="Input the URL...">
                <button id="btn" class="pure-button pure-button-primary" disabled>Gimme Gimme!</button>
            </fieldset>
        </form>
        <p>
            <a id="result" href=""></a>
        <div id="countdown"></div>
        </p>
        <p id="error"></p>
    </div>
    <script>
        let globalTiming
        const TIME = 300
        const BTN_COLOR_TIME = 900
        function timing(second) {
            const min = Math.floor(second / 60)
            const sec = second % 60
            return `${min}:${sec < 10 ? '0' : ''}${sec}`
        }
        function setupCountdown(elem) {
            if (globalTiming) {
                clearInterval(globalTiming)
            }
            let time = TIME
            elem.innerHTML = timing(time)
            globalTiming = setInterval(() => {
                time--
                elem.innerHTML = timing(time)
                if (time <= 0) {
                    elem.innerHTML = 'Expired'
                }
            }, 1000)
            setTimeout(() => {
                clearInterval(globalTiming)
                globalTiming = undefined
            }, (time + 1) * 1000);
        }
        const txt = document.querySelector('#url')
        const btn = document.querySelector('#btn')
        txt.addEventListener('input', (e) => {
            if (e.target.value.trim() === "") {
                btn.setAttribute('disabled', '')
            } else {
                btn.removeAttribute('disabled')
            }
        })
        btn.addEventListener('click', async (e) => {
            e.preventDefault()
            const url = document.querySelector('#url').value
            const ret = document.querySelector('#result')
            const err = document.querySelector('#error')
            const push = new URL(document.location)
            btn.setAttribute('disabled', '')
            btn.value = 'Pending...'
            push.searchParams.set('t', url)
            const result = await fetch(String(push), { method: "POST" }).then(async x => {
                const t = await x.text()
                if (x.status < 400) {
                    return t
                }
                throw t
            }).then(x => {
                btn.classList.add('button-success')
                setTimeout(() => {
                    btn.classList.remove('button-success')
                }, BTN_COLOR_TIME);
                ret.innerHTML = ret.href = x
                setupCountdown(document.querySelector('#countdown'))
            }).catch(e => {
                btn.classList.add('button-error')
                setTimeout(() => {
                    btn.classList.remove('button-error')
                }, BTN_COLOR_TIME);
                err.innerHTML = e
            })
            btn.value = 'OK'
            btn.removeAttribute('disabled')
        })
    </script>
</body>

</html>